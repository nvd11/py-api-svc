steps:
  # Build the container image
  - id: build docker image
    name: "gcr.io/cloud-builders/docker"
    args:
      [
        "build",
        "-t",
        "europe-west2-docker.pkg.dev/$PROJECT_ID/my-docker-repo/${_APP_NAME}:${_APP_TAG}",
        "-f",
        "Dockerfile",
        ".",
      ]

  # Push the container image to Google Container Registry
  - id: upload docker image to GAR
    name: "gcr.io/cloud-builders/docker"
    args:
      [
        "push",
        "europe-west2-docker.pkg.dev/$PROJECT_ID/my-docker-repo/${_APP_NAME}:${_APP_TAG}",
      ]

  # list gke nodes
  - id: test gke access
    name: "gcr.io/cloud-builders/kubectl"
    args:
      - "get"
      - "nodes"

    env:
      - "CLOUDSDK_COMPUTE_ZONE=europe-west2"
      - "CLOUDSDK_CONTAINER_CLUSTER=my-cluster1"

logsBucket: gs://jason-hsbc_cloudbuild/logs/
options: # https://cloud.google.com/cloud-build/docs/build-config#options
  logging: GCS_ONLY # or CLOUD_LOGGING_ONLY https://cloud.google.com/cloud-build/docs/build-config#logging

substitutions:
  _APP_NAME: py-api-svc
  _APP_TAG: latest

